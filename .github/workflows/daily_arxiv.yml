name: Daily arXiv Paper Notification

on:
  # 每2小时运行一次，检查是否有新论文
  # 程序会自动跳过今天已发送过邮件的情况
  schedule:
    - cron: '0 */2 * * *'
  
  # 允许手动触发
  workflow_dispatch:
    inputs:
      date:
        description: '指定日期 (YYYY-MM-DD)，留空则使用今天'
        required: false
        default: ''
      skip_crawl:
        description: '跳过爬取步骤（使用已有数据）'
        required: false
        default: 'false'
        type: boolean
      force_crawl:
        description: '强制爬取（忽略日期检查）'
        required: false
        default: 'false'
        type: boolean
      force_send:
        description: '强制发送邮件（今日已发送过时可用）'
        required: false
        default: 'false'
        type: boolean

env:
  PYTHON_VERSION: '3.11'

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Get current date
        id: date
        run: echo "today=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT
      
      - name: Create data directory
        run: mkdir -p data
      
      - name: Restore send status cache
        uses: actions/cache@v4
        with:
          path: |
            data/.last_email_date
            data/.last_crawl_date
          # 使用日期作为 key，同一天的运行共享状态
          key: arxiv-status-${{ steps.date.outputs.today }}
          restore-keys: |
            arxiv-status-
      
      - name: Run arXiv notifier
        env:
          # ===== arXiv 配置 =====
          ARXIV_CATEGORIES: ${{ secrets.ARXIV_CATEGORIES }}
          
          # ===== 关键词匹配配置 =====
          MATCHING_KEYWORDS: ${{ secrets.MATCHING_KEYWORDS }}
          MATCHING_THRESHOLD: ${{ vars.MATCHING_THRESHOLD }}
          MATCHING_TOP_K: ${{ vars.MATCHING_TOP_K }}
          
          # ===== LLM 配置 =====
          LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
          LLM_MODEL: ${{ secrets.LLM_MODEL }}
          LLM_BASE_URL: ${{ secrets.LLM_BASE_URL }}
          LLM_BATCH_SIZE: ${{ vars.LLM_BATCH_SIZE }}
          
          # ===== 邮件配置 =====
          EMAIL_SMTP_SERVER: ${{ secrets.EMAIL_SMTP_SERVER }}
          EMAIL_SMTP_PORT: ${{ vars.EMAIL_SMTP_PORT }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECIPIENTS: ${{ secrets.EMAIL_RECIPIENTS }}
        run: |
          # 构建命令参数
          ARGS=""
          
          # 检查是否指定了日期
          if [ -n "${{ github.event.inputs.date }}" ]; then
            ARGS="$ARGS --date ${{ github.event.inputs.date }}"
          fi
          
          # 检查是否跳过爬取
          if [ "${{ github.event.inputs.skip_crawl }}" = "true" ]; then
            ARGS="$ARGS --skip-crawl"
          fi
          
          # 检查是否强制爬取
          if [ "${{ github.event.inputs.force_crawl }}" = "true" ]; then
            ARGS="$ARGS --force"
          fi
          
          # 检查是否强制发送
          if [ "${{ github.event.inputs.force_send }}" = "true" ]; then
            ARGS="$ARGS --force-send"
          fi
          
          echo "Running: python main.py $ARGS"
          python main.py $ARGS
      
      - name: Upload digest as artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: paper-digest-${{ github.run_number }}
          path: |
            data/digests/*.md
            logs/*.log
          retention-days: 30
          if-no-files-found: ignore
